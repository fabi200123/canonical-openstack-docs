Using Vault
===========

This feature is used to encrypt all cloud service endpoints (both public
and private) using TLS certificates generated by Vault, which acts as an intermediary CA.
It does this by interfacing with the existing Traefik instances in the
cloud. A Traefik instance is associated with either public or private
cloud traffic.

Prerequisites
-------------

To use TLS Vault, you must enable the Vault feature in your cloud and unseal and authorize the Vault charm.
Follow this guide :doc:`Enable Vault </how-to/features/vault>`.

Enable TLS Vault
----------------

To enable TLS Vault, youâ€™ll need to provide information that identifies your
chosen Certificate Authority. Do this by specifying a CA certificate and
its CA certificate chain.

Run the following command to enable TLS Vault for public endpoints:

::

   sunbeam enable tls vault --ca <base64 encoded ca certificate> --ca-chain <base64 encoded ca chain>

To enable TLS Vault for public, internal and rgw endpoints, be explicit by
using the ``--endpoint`` option:

::

   sunbeam enable tls vault --ca <base64 encoded ca certificate> --ca-chain <base64 encoded ca chain> --endpoint public --endpoint internal --endpoint rgw

Use TLS Vault
-------------

After enabling TLS Vault, follow these steps to allow Vault to issue TLS certificates:

1. **Get CSR for Vault**: You need to generate a Certificate Signing Request (CSR) for Vault. This is done by running the following command:

   ::

      sunbeam tls vault list_outstanding_csrs

2. **Sign the CSR**: After generating the CSR, you need to sign it using the root CA certificate, defined at the time of enabling TLS Vault.

.. note::
   The CA certificate needs to be generated as a CA certificate, not just a regular TLS certificate. Vault will set its `common_name` configuration option to the domain from `external_hostname` configuration set during the bootstrapping of sunbeam. The CA certificate must have the same domain defined in the `alt_names` section of the CA configuration file used to sign the CSR.

3. **Deploy the signed certificate**: Once you have signed the CSR, you can deploy it to the Vault instance. This is done by running the following command:

   ::

      sunbeam tls vault unit_certs

Once the signed certificate is deployed, Vault will automatically issue TLS certificates for the endpoints specified during the TLS Vault enablement process. These certificates will be used by the Traefik instances to secure the cloud service endpoints.

Disable TLS Vault
-----------------

To disable TLS Vault in the cloud, run the following command:

::

   sunbeam disable tls vault

This command removes the `manual-tls-certificates` charm and removes Vault from being the intermediary certificate authority, as well as, unsetting all `external hostnames` of Traefik endpoints. All services will work as if TLS was never enabled.
